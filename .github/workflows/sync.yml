name: Auto Sync Fork with Releases

on:
  schedule:
    - cron: '0 17 * * *'  # æ¯å¤© UTC 17 ç‚¹è‡ªåŠ¨è¿è¡Œ
  workflow_dispatch:      # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      release_age_days:
        description: 'åªåŒæ­¥æœ€è¿‘å¤šå°‘å¤©å†…çš„Release (é»˜è®¤3å¤©)'
        required: false
        default: '3'

permissions:
  contents: write
  actions: read

# æ·»åŠ å¹¶å‘æ§åˆ¶ï¼Œé˜²æ­¢å¤šä¸ªå·¥ä½œæµåŒæ—¶è¿è¡Œ
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  sync-fork:
    runs-on: ubuntu-latest
    steps:
      # 1ï¸âƒ£ åˆå§‹ç£ç›˜ç©ºé—´æ£€æŸ¥
      - name: Check initial disk space
        run: |
          echo "åˆå§‹ç£ç›˜ç©ºé—´ä½¿ç”¨æƒ…å†µ:"
          df -h
          echo "å½“å‰ç›®å½•: $(pwd)"
          echo "å·¥ä½œç©ºé—´å†…å®¹:"
          ls -la

      # 2ï¸âƒ£ æ£€å‡ºä½ çš„ fork ä»“åº“
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.SYNC_PAT }}
          persist-credentials: true
          fetch-depth: 0

      # 3ï¸âƒ£ å®‰è£…å¿…è¦å·¥å…·
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl
          # å®‰è£… GitHub CLI
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt-get update
          sudo apt-get install -y gh

      # 4ï¸âƒ£ é…ç½® Git
      - name: Configure git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          # é…ç½®è®¤è¯ä½¿ç”¨ PAT
          git config --global credential.helper store
          echo "https://${{ github.actor }}:${{ secrets.SYNC_PAT }}@github.com" > ~/.git-credentials

      # 5ï¸âƒ£ æ¸…ç†ç£ç›˜ç©ºé—´
      - name: Clean up disk space
        run: |
          echo "æ¸…ç†ç£ç›˜ç©ºé—´..."
          # æ¸…ç†åŒ…ç®¡ç†å™¨ç¼“å­˜
          sudo apt-get clean || true
          # åˆ é™¤æœªä½¿ç”¨çš„åŒ…
          sudo apt-get autoremolve -y || true
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          sudo rm -rf /tmp/* || true
          sudo rm -rf /var/tmp/* || true
          # æ¸…ç†æ—¥å¿—æ–‡ä»¶
          sudo find /var/log -name "*.log" -type f -mtime +0 -delete 2>/dev/null || true
          sudo find /var.log -name "*.gz" -type f -delete 2>/dev/null || true
          
          echo "æ¸…ç†åç£ç›˜ç©ºé—´ä½¿ç”¨æƒ…å†µ:"
          df -h

      # 6ï¸âƒ£ è·å–é»˜è®¤åˆ†æ”¯
      - name: Get default branch
        id: get_default_branch
        run: |
          default_branch=$(git remote show origin | grep 'HEAD branch' | awk '{print $NF}')
          echo "Default branch: $default_branch"
          echo "default_branch=$default_branch" >> $GITHUB_OUTPUT
          echo "DEFAULT_BRANCH=$default_branch" >> $GITHUB_ENV

      # 7ï¸âƒ£ å¤‡ä»½å·¥ä½œæµæ–‡ä»¶
      - name: Backup workflow files
        run: |
          mkdir -p /tmp/backup
          # åªå¤‡ä»½åŒæ­¥å·¥ä½œæµæœ¬èº«
          if [ -f ".github/workflows/sync.yml" ]; then
            cp .github/workflows/sync.yml /tmp/backup/
            echo "Backed up sync workflow"
          else
            echo "No sync workflow found to backup"
          fi

      # 8ï¸âƒ£ åˆ é™¤æ‰€æœ‰å¯èƒ½å¯¼è‡´é—®é¢˜çš„å·¥ä½œæµæ–‡ä»¶
      - name: Remove problematic workflow files
        run: |
          # åˆ é™¤æ‰€æœ‰å¯èƒ½è§¦å‘æ„å»ºçš„å·¥ä½œæµæ–‡ä»¶
          rm -f .github/workflows/build.yml 2>/dev/null || true
          rm -f .github/workflows/android.yml 2>/dev/null || true
          rm -f .github/workflows/ci.yml 2>/dev/null || true
          rm -f .github/workflows/release.yml 2>/dev/null || true
          echo "Removed problematic workflow files"
          
          # åˆ é™¤ Android ç­¾åé…ç½®æ–‡ä»¶
          rm -f android/key.properties 2>/dev/null || true
          rm -f android/app/android_keystore.jks 2>/dev/null || true
          # åˆ é™¤å¯èƒ½å¼•ç”¨è¿™äº›æ–‡ä»¶çš„ Gradle é…ç½®
          sed -i '/android_keystore/d' android/app/build.gradle 2>/dev/null || true
          echo "Removed Android config files"

      # 9ï¸âƒ£ æ·»åŠ ä¸Šæ¸¸ä»“åº“å¹¶è·å–æ‰€æœ‰å†…å®¹
      - name: Add upstream and fetch
        run: |
          git remote remove upstream 2>/dev/null || true
          git remote add upstream https://github.com/brave/brave-browser.git
          git fetch upstream --tags --force --prune
          git fetch upstream --force --prune '+refs/heads/*:refs/remotes/upstream/*'

      # ğŸ”Ÿ åŒæ­¥æ‰€æœ‰åˆ†æ”¯ï¼ˆä¿ç•™å·¥ä½œæµæ–‡ä»¶ï¼‰
      - name: Sync branches with workflow preservation
        run: |
          # ä½¿ç”¨ä¹‹å‰è·å–çš„é»˜è®¤åˆ†æ”¯
          default_branch=${{ steps.get_default_branch.outputs.default_branch }}
          echo "Default branch: $default_branch"
          
          # è·å–ä¸Šæ¸¸æ‰€æœ‰åˆ†æ”¯
          git show-ref | grep 'refs/remotes/upstream/' | while read hash ref; do
            branch_name=${ref#refs/remotes/upstream/}
            
            # è·³è¿‡ HEAD å¼•ç”¨
            if [ "$branch_name" = "HEAD" ]; then
              continue
            fi
            
            echo "Processing branch: $branch_name"
            
            # åˆ›å»ºæˆ–æ›´æ–°æœ¬åœ°åˆ†æ”¯
            if git show-ref --verify --quiet refs/heads/$branch_name; then
              echo "Updating existing branch: $branch_name"
              git checkout $branch_name
              
              # å¯¹äºé»˜è®¤åˆ†æ”¯ï¼Œä½¿ç”¨åˆå¹¶è€Œä¸æ˜¯é‡ç½®ï¼Œä»¥ä¿ç•™å·¥ä½œæµæ–‡ä»¶
              if [ "$branch_name" = "$default_branch" ]; then
                echo "Merging upstream changes to default branch (preserving workflows)"
                # å…³é”®ä¿®æ”¹ï¼šæ·»åŠ  --allow-unrelated-histories é€‰é¡¹
                git merge --no-commit --allow-unrelated-histories upstream/$branch_name
                
                # æ¢å¤å·¥ä½œæµæ–‡ä»¶
                if [ -f "/tmp/backup/sync.yml" ]; then
                  mkdir -p .github/workflows
                  cp /tmp/backup/sync.yml .github/workflows/
                  git add .github/workflows/sync.yml
                fi
                
                # æäº¤åˆå¹¶
                if ! git diff --cached --quiet; then
                  git commit -m "Merge upstream changes and preserve workflows"
                fi
              else
                # å¯¹äºéé»˜è®¤åˆ†æ”¯ï¼Œä½¿ç”¨ç¡¬é‡ç½®
                git reset --hard upstream/$branch_name
              fi
            else
              echo "Creating new branch: $branch_name"
              git checkout -b $branch_name upstream/$branch_name
            fi
            
            # æ¨é€åˆ° origin - ä½¿ç”¨å·²é…ç½®çš„è®¤è¯
            echo "Pushing $branch_name to origin"
            git push origin $branch_name --force
          done

      # 1ï¸âƒ£1ï¸âƒ£ åŒæ­¥æ‰€æœ‰æ ‡ç­¾
      - name: Sync all tags
        run: |
          # åˆ é™¤æ‰€æœ‰æœ¬åœ°æ ‡ç­¾ï¼ˆé¿å…å†²çªï¼‰
          git tag -l | xargs git tag -d 2>/dev/null || true
          # è·å–ä¸Šæ¸¸æ‰€æœ‰æ ‡ç­¾
          git fetch upstream --tags --force
          # æ¨é€æ‰€æœ‰æ ‡ç­¾åˆ°origin
          git push origin --tags --force

      # 1ï¸âƒ£2ï¸âƒ£ åˆ›å»ºå¯è°ƒèŠ‚æ—¶é—´èŒƒå›´çš„åŒæ­¥è„šæœ¬
      - name: Create time-filtered sync script
        run: |
          cat > time_filtered_sync.sh << 'EOF'
          #!/bin/bash
          
          # è®¾ç½®ç¯å¢ƒå˜é‡
          export GITHUB_TOKEN="${{ secrets.SYNC_PAT }}"
          export REPO_DIR="$GITHUB_WORKSPACE"
          export GITHUB_USER="${{ github.repository_owner }}"
          export REPO_NAME="${{ github.event.repository.name }}"
          export UPSTREAM_OWNER="brave"
          export UPSTREAM_REPO="brave-browser"
          export LOG_FILE="$GITHUB_WORKSPACE/sync.log"
          export TEMP_DIR="/tmp/time_filtered_sync"
          export STATE_FILE="$REPO_DIR/.sync_state"
          export DEFAULT_BRANCH="${{ env.DEFAULT_BRANCH }}"
          
          # è®¾ç½®æ—¶é—´èŒƒå›´å‚æ•°ï¼ˆé»˜è®¤3å¤©ï¼‰
          RELEASE_AGE_DAYS=${RELEASE_AGE_DAYS:-3}
          echo "$(date '+%Y-%m-%d %H:%M:%S') - åªåŒæ­¥æœ€è¿‘ $RELEASE_AGE_DAYS å¤©å†…çš„Release" >> "$LOG_FILE"
          
          # è®¡ç®—æˆªæ­¢æ—¥æœŸï¼ˆä¿®å¤æ—¶é—´è®¡ç®—é—®é¢˜ï¼‰
          CUTOFF_DATE=$(date -u -d "-$RELEASE_AGE_DAYS days" +%Y-%m-%dT%H:%M:%SZ)
          echo "$(date '+%Y-%m-%d %H:%M:%S') - æˆªæ­¢æ—¥æœŸ: $CUTOFF_DATE" >> "$LOG_FILE"
          echo "$(date '+%Y-%m-%d %H:%M:%S') - å½“å‰æ—¥æœŸ: $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> "$LOG_FILE"
          
          # åˆ›å»ºä¸´æ—¶ç›®å½•
          mkdir -p "$TEMP_DIR"
          
          # è¿›å…¥ä»“åº“ç›®å½•
          cd "$REPO_DIR"
          
          # è®°å½•æ—¥å¿—
          echo "$(date '+%Y-%m-%d %H:%M:%S') - å¼€å§‹æ—¶é—´è¿‡æ»¤åŒæ­¥å‘å¸ƒ..." >> "$LOG_FILE"
          echo "$(date '+%Y-%m-%d %H:%M:%S') - å·¥ä½œç›®å½•: $(pwd)" >> "$LOG_FILE"
          echo "$(date '+%Y-%m-%d %H:%M:%S') - ç£ç›˜ç©ºé—´æƒ…å†µ:" >> "$LOG_FILE"
          df -h . >> "$LOG_FILE"
          
          # æ£€æŸ¥APIé™åˆ¶çš„å‡½æ•°
          check_rate_limit() {
            local response=$(curl -s -H "Authorization: token $GITHUB_TOKEN" https://api.github.com/rate_limit)
            local remaining=$(echo "$response" | jq -r '.resources.core.remaining')
            local reset=$(echo "$response" | jq -r '.resources.core.reset')
            
            if [ -z "$remaining" ] || [ -z "$reset" ]; then
              echo "$(date '+%Y-%m-%d %H:%M:%S') - æ— æ³•è·å–APIé™åˆ¶ä¿¡æ¯ï¼Œç»§ç»­æ‰§è¡Œ..." >> "$LOG_FILE"
              return 0
            fi
            
            local current_time=$(date +%s)
            local reset_in=$((reset - current_time))
            
            if [ "$remaining" -lt 50 ]; then
              echo "$(date '+%Y-%m-%d %H:%M:%S') - APIé™åˆ¶æ¥è¿‘ ($remaining æ¬¡è¯·æ±‚å‰©ä½™)" >> "$LOG_FILE"
              echo "$(date '+%Y-%m-%d %H:%M:%S') - å°†åœ¨ $reset_in ç§’åé‡ç½®ï¼Œç­‰å¾…ä¸­..." >> "$LOG_FILE"
              if [ "$reset_in" -gt 0 ]; then
                sleep $((reset_in + 10))
              fi
              return 1
            fi
            return 0
          }
          
          # å¸¦é‡è¯•çš„APIè¯·æ±‚å‡½æ•°
          api_request() {
            local url=$1
            local output=$2
            local retries=5
            local delay=10
            
            for ((i=1; i<=retries; i++)); do
              check_rate_limit
              local http_code=$(curl -s -o "$output" -w "%{http_code}" \
                -H "Authorization: token $GITHUB_TOKEN" \
                -H "Accept: application/vnd.github.v3+json" \
                "$url")
              
              if ! echo "$http_code" | grep -qE '^[0-9]+$'; then
                echo "$(date '+%Y-%m-%d %H:%M:%S') - APIè¯·æ±‚å¤±è´¥: æ— æ•ˆçš„HTTPçŠ¶æ€ç  '$http_code'" >> "$LOG_FILE"
                sleep $delay
                continue
              fi
              
              if [ "$http_code" -eq 200 ]; then
                return 0
              elif [ "$http_code" -eq 403 ]; then
                echo "$(date '+%Y-%m-%d %H:%M:%S') - APIè¯·æ±‚è¢«é™åˆ¶ (HTTP $http_code)ï¼Œç­‰å¾…åé‡è¯•..." >> "$LOG_FILE"
                sleep 60
              elif [ "$http_code" -eq 404 ]; then
                echo "$(date '+%Y-%m-%d %H:%M:%S') - APIè¯·æ±‚çš„èµ„æºä¸å­˜åœ¨ (HTTP $http_code)" >> "$LOG_FILE"
                return 1
              else
                echo "$(date '+%Y-%m-%d %H:%M:%S') - APIè¯·æ±‚å¤±è´¥ (HTTP $http_code)ï¼Œé‡è¯• $i/$retries..." >> "$LOG_FILE"
                sleep $delay
              fi
              rm -f "$output"
            done
            
            echo "$(date '+%Y-%m-%d %H:%M:%S') - APIè¯·æ±‚å¤±è´¥: $url" >> "$LOG_FILE"
            return 1
          }
          
          # è·å–æ‰€æœ‰Releaseï¼ˆå¤„ç†åˆ†é¡µï¼‰- ä¿®å¤ç‰ˆæœ¬
          get_all_releases() {
            local owner=$1
            local repo=$2
            local page=1
            local all_releases_file="$TEMP_DIR/all_releases.json"
            
            # åˆå§‹åŒ–ç©ºæ•°ç»„
            echo "[]" > "$all_releases_file"
            
            echo "$(date '+%Y-%m-%d %H:%M:%S') - å¼€å§‹è·å–æ‰€æœ‰ $owner/$repo çš„Releaseï¼ˆå¤„ç†åˆ†é¡µï¼‰..." >> "$LOG_FILE"
            
            while true; do
              echo "$(date '+%Y-%m-%d %H:%M:%S') - è·å–ç¬¬ $page é¡µRelease..." >> "$LOG_FILE"
              
              local url="https://api.github.com/repos/$owner/$repo/releases?page=$page&per_page=100"
              local output_file="$TEMP_DIR/${owner}_${repo}_releases_page_$page.json"
              
              if api_request "$url" "$output_file"; then
                # æ£€æŸ¥æ˜¯å¦ä¸ºç©ºé¡µ
                local page_count=$(jq length "$output_file")
                if [ "$page_count" -eq 0 ]; then
                  echo "$(date '+%Y-%m-%d %H:%M:%S') - ç¬¬ $page é¡µä¸ºç©ºï¼Œåœæ­¢åˆ†é¡µ" >> "$LOG_FILE"
                  break
                fi
                
                echo "$(date '+%Y-%m-%d %H:%M:%S') - ç¬¬ $page é¡µè·å–æˆåŠŸï¼Œå…± $page_count ä¸ªRelease" >> "$LOG_FILE"
                
                # ä½¿ç”¨ä¸´æ—¶æ–‡ä»¶åˆå¹¶JSONæ•°æ®ï¼Œé¿å…å‚æ•°è¿‡é•¿
                jq -s '.[0] + .[1]' "$all_releases_file" "$output_file" > "${all_releases_file}.tmp"
                mv "${all_releases_file}.tmp" "$all_releases_file"
                
                page=$((page + 1))
                
                # æ·»åŠ å»¶è¿Ÿä»¥é¿å…é€Ÿç‡é™åˆ¶
                sleep 2
              else
                echo "$(date '+%Y-%m-%d %H:%M:%S') - è·å–ç¬¬ $page é¡µReleaseå¤±è´¥" >> "$LOG_FILE"
                break
              fi
            done
            
            local total_count=$(jq length "$all_releases_file")
            echo "$(date '+%Y-%m-%d %H:%M:%S') - æ€»å…±è·å– $total_count ä¸ªRelease" >> "$LOG_FILE"
            
            # è¿‡æ»¤å‡ºæœ€è¿‘æŒ‡å®šå¤©æ•°å†…çš„Releaseï¼Œå¹¶æ’é™¤è‰ç¨¿å‘å¸ƒ
            echo "$(date '+%Y-%m-%d %H:%M:%S') - è¿‡æ»¤æœ€è¿‘ $RELEASE_AGE_DAYS å¤©å†…çš„Releaseï¼ˆæ’é™¤è‰ç¨¿ï¼‰..." >> "$LOG_FILE"
            jq --arg cutoff "$CUTOFF_DATE" '
              map(select(.published_at != null and .published_at >= $cutoff and .draft == false))
            ' "$all_releases_file" > "${all_releases_file}_filtered.json"
            
            local filtered_count=$(jq length "${all_releases_file}_filtered.json")
            echo "$(date '+%Y-%m-%d %H:%M:%S') - è¿‡æ»¤åå‰©ä½™ $filtered_count ä¸ªRelease" >> "$LOG_FILE"
            
            # è°ƒè¯•ï¼šè¾“å‡ºå‰å‡ ä¸ªå‘å¸ƒçš„æ—¥æœŸ
            echo "$(date '+%Y-%m-%d %H:%M:%S') - å‰å‡ ä¸ªå‘å¸ƒçš„æ—¥æœŸ:" >> "$LOG_FILE"
            jq -r '.[0:5] | .[] | "\(.tag_name): \(.published_at)"' "${all_releases_file}_filtered.json" >> "$LOG_FILE" 2>/dev/null || true
            
            cat "${all_releases_file}_filtered.json"
          }
          
          # ç‰ˆæœ¬å·æ¯”è¾ƒå‡½æ•°
          version_compare() {
            local a=$1
            local b=$2
            
            # ç§»é™¤å¯èƒ½çš„å‰ç¼€ï¼ˆå¦‚"v"ï¼‰
            a=${a#v}
            b=${b#v}
            
            # åˆ†å‰²ç‰ˆæœ¬å·ä¸ºæ•°ç»„
            IFS='.' read -ra a_parts <<< "$a"
            IFS='.' read -ra b_parts <<< "$b"
            
            # æ¯”è¾ƒæ¯ä¸ªéƒ¨åˆ†
            for i in "${!a_parts[@]}"; do
              if [[ -z "${b_parts[i]}" ]]; then
                echo 1
                return
              fi
              
              if [[ "${a_parts[i]}" -gt "${b_parts[i]}" ]]; then
                echo 1
                return
              elif [[ "${a_parts[i]}" -lt "${b_parts[i]}" ]]; then
                echo -1
                return
              fi
            done
            
            # å¦‚æœaçš„ç‰ˆæœ¬å·éƒ¨åˆ†æ›´å°‘ï¼Œä½†å‰é¢çš„éƒ¨åˆ†éƒ½ç›¸ç­‰ï¼Œåˆ™aæ›´å°
            if [[ ${#a_parts[@]} -lt ${#b_parts[@]} ]]; then
              echo -1
              return
            fi
            
            echo 0
          }
          
          # æŒ‰ç‰ˆæœ¬å·æ’åºå‡½æ•°
          sort_by_version() {
            local releases=$1
            local sorted_file="$TEMP_DIR/sorted_releases.json"
            
            echo "$releases" > "$sorted_file"
            
            # ä½¿ç”¨ç‰ˆæœ¬å·æ¯”è¾ƒå‡½æ•°è¿›è¡Œæ’åº
            # ç”±äºjqä¸æ”¯æŒè‡ªå®šä¹‰æ¯”è¾ƒå‡½æ•°ï¼Œæˆ‘ä»¬ä½¿ç”¨å¤–éƒ¨æ’åº
            # é¦–å…ˆæå–ç‰ˆæœ¬å·å’Œæ•´ä¸ªå¯¹è±¡
            echo "$releases" | jq -c '.[]' | while read -r release; do
              tag_name=$(echo "$release" | jq -r '.tag_name')
              echo "$tag_name $release"
            done | sort -t ' ' -k1,1 -V | cut -d' ' -f2- | jq -s '.' > "$sorted_file"
            
            cat "$sorted_file"
          }
          
          # è¯»å–çŠ¶æ€æ–‡ä»¶
          read_state() {
            if [ -f "$STATE_FILE" ]; then
              source "$STATE_FILE"
              echo "$(date '+%Y-%m-%d %H:%M:%S') - è¯»å–åŒæ­¥çŠ¶æ€: æœ€ååŒæ­¥æ ‡ç­¾=$LAST_SYNC_TAG, æœ€ååŒæ­¥æ—¶é—´=$LAST_SYNC_TIME" >> "$LOG_FILE"
            else
              # é¦–æ¬¡è¿è¡Œï¼Œåˆå§‹åŒ–çŠ¶æ€
              LAST_SYNC_TAG=""
              LAST_SYNC_TIME=""
              echo "$(date '+%Y-%m-%d %H:%M:%S') - é¦–æ¬¡è¿è¡Œï¼Œéœ€è¦åŒæ­¥æ‰€æœ‰Release" >> "$LOG_FILE"
            fi
          }
          
          # å†™å…¥çŠ¶æ€æ–‡ä»¶
          write_state() {
            local tag=$1
            local time=$2
            
            echo "LAST_SYNC_TAG=\"$tag\"" > "$STATE_FILE"
            echo "LAST_SYNC_TIME=\"$time\"" >> "$STATE_FILE"
            echo "$(date '+%Y-%m-%d %H:%M:%S') - æ›´æ–°åŒæ­¥çŠ¶æ€: æœ€ååŒæ­¥æ ‡ç­¾=$tag, æœ€ååŒæ­¥æ—¶é—´=$time" >> "$LOG_FILE"
          }
          
          # ä¿®å¤ç£ç›˜ç©ºé—´æ£€æŸ¥å‡½æ•° - é™ä½é˜ˆå€¼åˆ°1GB
          check_disk_space() {
            # è·å–å½“å‰ç›®å½•çš„å¯ç”¨ç©ºé—´ï¼ˆä»¥KBä¸ºå•ä½ï¼‰
            local available_kb=$(df -k . | awk 'NR==2 {print $4}')
            
            # ç¡®ä¿available_kbæ˜¯æ•°å­—
            if ! echo "$available_kb" | grep -qE '^[0-9]+$'; then
              echo "$(date '+%Y-%m-%d %H:%M:%S') - æ— æ³•è·å–ç£ç›˜ç©ºé—´ä¿¡æ¯" >> "$LOG_FILE"
              return 1
            fi
            
            # è½¬æ¢ä¸ºå­—èŠ‚
            local available_bytes=$((available_kb * 1024))
            
            echo "$(date '+%Y-%m-%d %H:%M:%S') - å¯ç”¨ç£ç›˜ç©ºé—´: $available_kb KB ($available_bytes å­—èŠ‚)" >> "$LOG_FILE"
            
            # æ£€æŸ¥æ˜¯å¦å°äº1GBï¼ˆé™ä½é˜ˆå€¼ï¼‰
            if [ "$available_bytes" -lt 1000000000 ]; then  # 1GB = 1,000,000,000 å­—èŠ‚
              echo "$(date '+%Y-%m-%d %H:%M:%S') - ç£ç›˜ç©ºé—´ä¸è¶³ (å°äº1GB)" >> "$LOG_FILE"
              return 1
            fi
            
            return 0
          }
          
          # æ£€æŸ¥æœ¬åœ°æ˜¯å¦å·²å­˜åœ¨Release
          check_local_release_exists() {
            local tag_name=$1
            local local_releases=$2
            
            for j in $(seq 0 $(($(echo "$local_releases" | jq length) - 1))); do
              local_release=$(echo "$local_releases" | jq -c ".[$j]")
              local_tag_name=$(echo "$local_release" | jq -r '.tag_name')
              
              if [ "$tag_name" = "$local_tag_name" ]; then
                local_release_id=$(echo "$local_release" | jq -r '.id')
                echo "$(date '+%Y-%m-%d %H:%M:%S') - Release $tag_name å·²å­˜åœ¨ (ID: $local_release_id)" >> "$LOG_FILE"
                
                # æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°èµ„äº§
                local_assets=$(echo "$local_release" | jq -r '.assets | length')
                upstream_assets=$3
                
                if [ "$local_assets" -lt "$upstream_assets" ]; then
                  echo "$(date '+%Y-%m-%d %H:%M:%S') - æœ¬åœ°Releaseç¼ºå°‘èµ„äº§ ($local_assets/$upstream_assets)ï¼Œå¯èƒ½éœ€è¦æ›´æ–°" >> "$LOG_FILE"
                  return 1  # è¿”å›1è¡¨ç¤ºéœ€è¦æ›´æ–°
                else
                  echo "$(date '+%Y-%m-%d %H:%M:%S') - æœ¬åœ°Releaseèµ„äº§å®Œæ•´ï¼Œè·³è¿‡åŒæ­¥" >> "$LOG_FILE"
                  return 0  # è¿”å›0è¡¨ç¤ºå·²å­˜åœ¨ä¸”å®Œæ•´
                fi
              fi
            done
            
            return 2  # è¿”å›2è¡¨ç¤ºä¸å­˜åœ¨
          }
          
          # ç™»å½•GitHub CLI
          echo "$(date '+%Y-%m-%d %H:%M:%S') - ç™»å½•GitHub CLI..." >> "$LOG_FILE"
          echo "$GITHUB_TOKEN" | gh auth login --with-token >> "$LOG_FILE" 2>&1
          
          # è¯»å–ä¸Šæ¬¡åŒæ­¥çŠ¶æ€
          read_state
          
          # æ£€æŸ¥ç£ç›˜ç©ºé—´ - åªåœ¨å¼€å§‹æ—¶æ£€æŸ¥ä¸€æ¬¡
          if ! check_disk_space; then
            echo "$(date '+%Y-%m-%d %H:%M:%S') - ç£ç›˜ç©ºé—´ä¸è¶³ï¼Œåœæ­¢æ‰§è¡Œ" >> "$LOG_FILE"
            exit 1
          fi
          
          # è·å–ä¸Šæ¸¸æ‰€æœ‰Release
          echo "$(date '+%Y-%m-%d %H:%M:%S') - è·å–ä¸Šæ¸¸æ‰€æœ‰Release..." >> "$LOG_FILE"
          upstream_releases=$(get_all_releases "$UPSTREAM_OWNER" "$UPSTREAM_REPO")
          upstream_count=$(echo "$upstream_releases" | jq length)
          echo "$(date '+%Y-%m-%d %H:%M:%S') - å…±è·å– $upstream_count ä¸ªä¸Šæ¸¸Releaseï¼ˆè¿‡æ»¤åï¼‰" >> "$LOG_FILE"
          
          # è·å–æœ¬åœ°æ‰€æœ‰Release
          echo "$(date '+%Y-%m-%d %H:%M:%S') - è·å–æœ¬åœ°æ‰€æœ‰Release..." >> "$LOG_FILE"
          local_releases=$(get_all_releases "$GITHUB_USER" "$REPO_NAME")
          local_count=$(echo "$local_releases" | jq length)
          echo "$(date '+%Y-%m-%d %H:%M:%S') - å…±è·å– $local_count ä¸ªæœ¬åœ°Release" >> "$LOG_FILE"
          
          # å¦‚æœæ²¡æœ‰éœ€è¦åŒæ­¥çš„Releaseï¼Œåˆ™é€€å‡º
          if [ "$upstream_count" -eq 0 ]; then
            echo "$(date '+%Y-%m-%d %H:%M:%S') - æ²¡æœ‰éœ€è¦åŒæ­¥çš„Releaseï¼Œé€€å‡º" >> "$LOG_FILE"
            exit 0
          fi
          
          # æŒ‰ç‰ˆæœ¬å·æ’åºä¸Šæ¸¸Release
          echo "$(date '+%Y-%m-%d %H:%M:%S') - æŒ‰ç‰ˆæœ¬å·æ’åºä¸Šæ¸¸Release..." >> "$LOG_FILE"
          sorted_upstream_releases=$(sort_by_version "$upstream_releases")
          echo "$sorted_upstream_releases" > "$TEMP_DIR/sorted_upstream_releases.json"
          
          # å¤„ç†æ¯ä¸ªRelease
          release_count=0
          skipped_count=0
          failed_count=0
          
          for i in $(seq 0 $((upstream_count - 1))); do
            # ä½¿ç”¨jqç›´æ¥ä»æ–‡ä»¶è¯»å–ï¼Œé¿å…å‚æ•°è¿‡é•¿
            release=$(jq -c ".[$i]" "$TEMP_DIR/sorted_upstream_releases.json")
            tag_name=$(echo "$release" | jq -r '.tag_name')
            name=$(echo "$release" | jq -r '.name')
            body=$(echo "$release" | jq -r '.body')
            draft=$(echo "$release" | jq -r '.draft')
            prerelease=$(echo "$release" | jq -r '.prerelease')
            release_id=$(echo "$release" | jq -r '.id')
            published_at=$(echo "$release" | jq -r '.published_at')
            html_url=$(echo "$release" | jq -r '.html_url')
            assets_count=$(echo "$release" | jq -r '.assets | length')
            
            echo "$(date '+%Y-%m-%d %H:%M:%S') - å¤„ç†Release: $tag_name (å‘å¸ƒæ—¶é—´: $published_at)" >> "$LOG_FILE"
            echo "$(date '+%Y-%m-%d %H:%M:%S') - Release URL: $html_url" >> "$LOG_FILE"
            echo "$(date '+%Y-%m-%d %H:%M:%S') - Draft: $draft, Prerelease: $prerelease, èµ„äº§æ•°é‡: $assets_count" >> "$LOG_FILE"
            
            # æ£€æŸ¥æœ¬åœ°æ˜¯å¦å·²å­˜åœ¨æ­¤Release
            check_local_release_exists "$tag_name" "$local_releases" "$assets_count"
            case $? in
              0)  # å·²å­˜åœ¨ä¸”å®Œæ•´
                skipped_count=$((skipped_count + 1))
                continue
                ;;
              1)  # å·²å­˜åœ¨ä½†ä¸å®Œæ•´ï¼Œéœ€è¦æ›´æ–°
                echo "$(date '+%Y-%m-%d %H:%M:%S') - Release $tag_name å·²å­˜åœ¨ä½†èµ„äº§ä¸å®Œæ•´ï¼Œéœ€è¦æ›´æ–°" >> "$LOG_FILE"
                ;;
              2)  # ä¸å­˜åœ¨ï¼Œéœ€è¦åˆ›å»º
                echo "$(date '+%Y-%m-%d %H:%M:%S') - Release $tag_name ä¸å­˜åœ¨ï¼Œéœ€è¦åˆ›å»º" >> "$LOG_FILE"
                ;;
            esac
            
            RELEASE_TEMP_DIR="$TEMP_DIR/release_$release_id"
            mkdir -p "$RELEASE_TEMP_DIR"
            echo "$release" > "$RELEASE_TEMP_DIR/release_info.json"
            
            asset_count=0
            assets=$(echo "$release" | jq -c '.assets[]' 2>/dev/null || echo "")
            
            if [ -n "$assets" ] && [ "$assets_count" -gt 0 ]; then
              echo "$assets" > "$RELEASE_TEMP_DIR/assets.json"
              echo "$(date '+%Y-%m-%d %H:%M:%S') - Release $tag_name æœ‰ $assets_count ä¸ªèµ„äº§" >> "$LOG_FILE"
              
              # ä¿®å¤èµ„äº§ä¸‹è½½é—®é¢˜ - ä½¿ç”¨æ­£ç¡®çš„å¾ªç¯æ–¹å¼
              while IFS= read -r asset; do
                browser_download_url=$(echo "$asset" | jq -r '.browser_download_url')
                filename=$(echo "$asset" | jq -r '.name')
                size=$(echo "$asset" | jq -r '.size')
                size_mb=$((size / 1024 / 1024))
                
                echo "$(date '+%Y-%m-%d %H:%M:%S') - ä¸‹è½½æ–‡ä»¶: $filename (å¤§å°: $size_mb MB)" >> "$LOG_FILE"
                echo "$(date '+%Y-%m-%d %H:%M:%S') - ä¸‹è½½URL: $browser_download_url" >> "$LOG_FILE"
                
                # ç§»é™¤æ–‡ä»¶å¤§å°é™åˆ¶ï¼Œåªæ£€æŸ¥åŸºæœ¬ç£ç›˜ç©ºé—´
                if ! check_disk_space; then
                  echo "$(date '+%Y-%m-%d %H:%M:%S') - ç£ç›˜ç©ºé—´ä¸è¶³ï¼Œè·³è¿‡æ–‡ä»¶ä¸‹è½½" >> "$LOG_FILE"
                  continue
                fi
                
                retries=5
                for ((j=1; j<=retries; j++)); do
                  # ä¿®å¤æ–‡ä»¶ä¸‹è½½ - ä½¿ç”¨æ­£ç¡®çš„curlå‘½ä»¤
                  if curl -L --fail \
                    -H "Authorization: token $GITHUB_TOKEN" \
                    -H "Accept: application/octet-stream" \
                    -o "$RELEASE_TEMP_DIR/$filename" \
                    "$browser_download_url" >> "$LOG_FILE" 2>&1; then
                    
                    # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ä¸‹è½½æˆåŠŸ
                    if [ -f "$RELEASE_TEMP_DIR/$filename" ]; then
                      downloaded_size=$(stat -c%s "$RELEASE_TEMP_DIR/$filename" 2>/dev/null || stat -f%z "$RELEASE_TEMP_DIR/$filename" 2>/dev/null)
                      # ä¸å†æ£€æŸ¥æ–‡ä»¶å¤§å°æ˜¯å¦åŒ¹é…ï¼Œå› ä¸ºå¤§æ–‡ä»¶å¯èƒ½ä¼šæœ‰å˜åŒ–
                      asset_count=$((asset_count + 1))
                      echo "$(date '+%Y-%m-%d %H:%M:%S') - æ–‡ä»¶ $filename ä¸‹è½½æˆåŠŸ ($downloaded_size å­—èŠ‚)" >> "$LOG_FILE"
                      break
                    else
                      echo "$(date '+%Y-%m-%d %H:%M:%S') - æ–‡ä»¶ä¸‹è½½å¤±è´¥: $filename" >> "$LOG_FILE"
                    fi
                  else
                    echo "$(date '+%Y-%m-%d %H:%M:%S') - ä¸‹è½½æ–‡ä»¶å¤±è´¥ï¼Œé‡è¯• $j/$retries..." >> "$LOG_FILE"
                    sleep 10
                  fi
                done
              done < "$RELEASE_TEMP_DIR/assets.json"
              
              rm -f "$RELEASE_TEMP_DIR/assets.json"
            else
              echo "$(date '+%Y-%m-%d %H:%M:%S') - Release $tag_name æ²¡æœ‰æ–‡ä»¶èµ„æº" >> "$LOG_FILE"
            fi
            
            echo "$(date '+%Y-%m-%d %H:%M:%S') - åˆ›å»ºRelease: $tag_name" >> "$LOG_FILE"
            
            # ç¡®ä¿ä¸åˆ›å»ºè‰ç¨¿å‘å¸ƒï¼Œå³ä½¿ä¸Šæ¸¸æœ‰è‰ç¨¿ï¼ˆä½†æˆ‘ä»¬å·²ç»è¿‡æ»¤æ‰äº†ï¼‰
            # åªå¤„ç†é¢„å‘å¸ƒå’Œæ­£å¼å‘å¸ƒ
            prerelease_flag=""
            
            if [ "$prerelease" = "true" ]; then
              prerelease_flag="--prerelease"
              echo "$(date '+%Y-%m-%d %H:%M:%S') - è¿™æ˜¯ä¸€ä¸ªé¢„å‘å¸ƒç‰ˆæœ¬" >> "$LOG_FILE"
            else
              echo "$(date '+%Y-%m-%d %H:%M:%S') - è¿™æ˜¯ä¸€ä¸ªæ­£å¼å‘å¸ƒç‰ˆæœ¬" >> "$LOG_FILE"
            fi
            
            # ä¿®å¤ç›®æ ‡æäº¤é—®é¢˜ - å…³é”®ä¿®æ”¹
            target_commitish=$(git rev-list -n 1 "$tag_name" 2>/dev/null || echo "")
            if [ -z "$target_commitish" ]; then
              echo "$(date '+%Y-%m-%d %H:%M:%S') - è­¦å‘Š: æ‰¾ä¸åˆ°æ ‡ç­¾ $tag_name å¯¹åº”çš„æäº¤ï¼Œä½¿ç”¨é»˜è®¤åˆ†æ”¯ $DEFAULT_BRANCH" >> "$LOG_FILE"
              target_commitish="$DEFAULT_BRANCH"
            fi
            
            echo "$(date '+%Y-%m-%d %H:%M:%S') - ä½¿ç”¨ç›®æ ‡æäº¤: $target_commitish" >> "$LOG_FILE"
            
            release_created=false
            retries=5
            
            for ((j=1; j<=retries; j++)); do
              if [ "$asset_count" -gt 0 ]; then
                # ä¿®å¤æ–‡ä»¶ä¸Šä¼  - ä½¿ç”¨æ­£ç¡®çš„gh releaseå‘½ä»¤
                if gh release create "$tag_name" \
                  --title "$name" \
                  --notes "$body" \
                  $prerelease_flag \
                  --target "$target_commitish" \
                  --repo "$GITHUB_USER/$REPO_NAME" \
                  "$RELEASE_TEMP_DIR"/* >> "$LOG_FILE" 2>&1; then
                  release_created=true
                  break
                fi
              else
                if gh release create "$tag_name" \
                  --title "$name" \
                  --notes "$body" \
                  $prerelease_flag \
                  --target "$target_commitish" \
                  --repo "$GITHUB_USER/$REPO_NAME" >> "$LOG_FILE" 2>&1; then
                  release_created=true
                  break
                fi
              fi
              
              echo "$(date '+%Y-%m-%d %H:%M:%S') - åˆ›å»ºReleaseå¤±è´¥ï¼Œé‡è¯• $j/$retries..." >> "$LOG_FILE"
              sleep 10
            done
            
            if [ "$release_created" = true ]; then
              release_count=$((release_count + 1))
              echo "$(date '+%Y-%m-%d %H:%M:%S') - Release $tag_name åˆ›å»ºæˆåŠŸ($asset_count ä¸ªæ–‡ä»¶)" >> "$LOG_FILE"
              
              # æ›´æ–°æœ€ååŒæ­¥çŠ¶æ€
              write_state "$tag_name" "$published_at"
            else
              failed_count=$((failed_count + 1))
              echo "$(date '+%Y-%m-%d %H:%M:%S') - åˆ›å»ºRelease $tag_name å¤±è´¥" >> "$LOG_FILE"
            fi
            
            # ç«‹å³æ¸…ç†å½“å‰Releaseçš„ä¸´æ—¶æ–‡ä»¶
            rm -rf "$RELEASE_TEMP_DIR"
            echo "$(date '+%Y-%m-%d %H:%M:%S') - å·²æ¸…ç†Release $tag_name çš„ä¸´æ—¶æ–‡ä»¶" >> "$LOG_FILE"
            
            sleep 5
          done
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -f "$TEMP_DIR"/*.json
          rm -rf "$TEMP_DIR"
          
          echo "$(date '+%Y-%m-%d %H:%M:%S') - åŒæ­¥å®Œæˆï¼Œå…±å¤„ç† $release_count ä¸ªReleaseï¼Œè·³è¿‡ $skipped_count ä¸ªï¼Œå¤±è´¥ $failed_count ä¸ª" >> "$LOG_FILE"
          EOF
          
          chmod +x time_filtered_sync.sh

      # 1ï¸âƒ£3ï¸âƒ£ è¿è¡Œæ—¶é—´è¿‡æ»¤åŒæ­¥è„šæœ¬
      - name: Run time-filtered sync script
        env:
          SYNC_PAT: ${{ secrets.SYNC_PAT }}
          RELEASE_AGE_DAYS: ${{ github.event.inputs.release_age_days || 3 }}
        run: ./time_filtered_sync.sh

      # 1ï¸âƒ£4ï¸âƒ£ ä¸Šä¼ æ—¥å¿—
      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sync-logs
          path: |
            sync.log
            ${{ github.workspace }}/sync.log

      # 1ï¸âƒ£5ï¸âƒ£ æœ€ç»ˆç£ç›˜ç©ºé—´æ£€æŸ¥
      - name: Check final disk space
        run: |
          echo "æœ€ç»ˆç£ç›˜ç©ºé—´ä½¿ç”¨æƒ…å†µ:"
          df -h
          echo "å·¥ä½œç›®å½•å¤§å°:"
          du -sh . || true

      # 1ï¸âƒ£6ï¸âƒ£ å‘é€å®Œæˆé€šçŸ¥
      - name: Notify on completion
        run: |
          echo "Sync completed at $(date)"
          echo "Repository: https://github.com/${{ github.repository }}"
          echo "Time filter: ${{ github.event.inputs.release_age_days || 3 }} days"
